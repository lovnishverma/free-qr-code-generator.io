<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro QR Studio — Generator, Scanner, Batch & Analytics</title>
  <meta name="description" content="Enterprise-grade QR generator & scanner with advanced styling, templates, batch CSV→ZIP, SVG/PNG export, logo overlay, presets, and optional analytics. 100% client-side." />
  
  <!-- ======= External Libraries (CDN) ======= -->
  <!-- Advanced QR rendering (supports SVG, logos, gradients, shapes) -->
  <script src="https://unpkg.com/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
  <!-- Camera decode -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <!-- ZIP for batch export -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <!-- FileSaver for saving ZIPs -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--accent:#22d3ee;--accent2:#38bdf8;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 10% -10%, #0e1630, #0b1220 60%),var(--bg);color:var(--text);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:var(--accent)}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:clamp(1.6rem,2.6vw,2.4rem);margin:0 0 4px;font-weight:800}
    .subtitle{color:var(--muted);margin:0 0 18px}
    .nav{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 18px}
    .tab{padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(180deg,#0e172b,#0b1220);color:var(--muted);cursor:pointer}
    .tab.active{color:#03131e;background:linear-gradient(180deg,var(--accent),var(--accent2));border-color:transparent;box-shadow:0 0 0 4px #22d3ee2a}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:linear-gradient(180deg,#0f172a,#0c1221);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 20px 50px #0005 inset, 0 10px 20px #0003}
    @media(min-width:1024px){.left{grid-column:span 7}.right{grid-column:span 5}}

    label{color:var(--muted);font-size:.9rem}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    input[type="text"], input[type="number"], input[type="file"], select, textarea{width:100%;background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 12px;outline:none}
    textarea{min-height:100px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{background:#0b1220;border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{border-color:#334155;box-shadow:0 0 0 4px #22d3ee1a}
    .primary{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#051018;border-color:transparent}
    .success{background:linear-gradient(180deg,#34d399,#22c55e);color:#01150b;border-color:transparent}
    .danger{background:linear-gradient(180deg,#fb7185,#ef4444);color:#2a070a;border-color:transparent}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0b1220;color:var(--muted)}
    .kbd{border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#1f2937,transparent);margin:12px 0}

    .preview{display:grid;place-items:center;background:radial-gradient(600px 400px at 80% 10%,#0b1220,#0a0f1e);border:1px dashed #1f2937;border-radius:14px;min-height:340px;overflow:hidden}
    #stage{display:grid;place-items:center}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;display:flex;gap:8px;align-items:center;background:#0f1a30;border:1px solid #1f2b45;color:#dbeafe;padding:10px 12px;border-radius:12px;opacity:0;transform:translateY(20px);transition:all .25s ease;z-index:999}
    .toast.show{opacity:1;transform:translateY(0)}

    .footer{margin-top:16px;color:var(--muted);font-size:.92rem}
    .note{font-size:.9rem;color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="container">
    <h1>Pro QR Studio</h1>
    <p class="subtitle">Advanced generator, scanner, batch processor, and analytics hooks — all client‑side.</p>

    <!-- Top navigation -->
    <div class="nav" role="tablist">
      <div id="tGen" class="tab active" role="tab" aria-controls="pGen" aria-selected="true">Generator</div>
      <div id="tScan" class="tab" role="tab" aria-controls="pScan" aria-selected="false">Scanner</div>
      <div id="tBatch" class="tab" role="tab" aria-controls="pBatch" aria-selected="false">Batch</div>
      <div id="tAnalytics" class="tab" role="tab" aria-controls="pAnalytics" aria-selected="false">Analytics</div>
      <div id="tAbout" class="tab" role="tab" aria-controls="pAbout" aria-selected="false">About</div>
    </div>

    <!-- ============= GENERATOR PANEL ============= -->
    <section id="pGen">
      <div class="grid">
        <!-- LEFT Controls -->
        <div class="card left">
          <h2 style="margin:0 0 8px">Content</h2>
          <div class="row">
            <div class="col-12">
              <label for="content">Text / URL</label>
              <textarea id="content" placeholder="Type text, URL, WiFi config, vCard, etc.">https://example.com</textarea>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col-6">
              <label for="preset">Preset</label>
              <select id="preset">
                <option value="custom" selected>Custom</option>
                <option value="wifi">Wi‑Fi</option>
                <option value="vcard">vCard</option>
                <option value="sms">SMS</option>
                <option value="email">Email</option>
                <option value="geo">Geo (Maps)</option>
                <option value="event">Event (iCal)</option>
              </select>
            </div>
            <div class="col-6">
              <label for="filename">File name (no ext)</label>
              <input id="filename" type="text" value="qr-code" />
            </div>
          </div>

          <div class="hr"></div>
          <h2 style="margin:0 0 8px">Styling</h2>
          <div class="row">
            <div class="col-4">
              <label for="size">Size (px)</label>
              <input id="size" type="number" min="128" max="2048" value="420" />
            </div>
            <div class="col-4">
              <label for="margin">Quiet Zone (px)</label>
              <input id="margin" type="number" min="0" max="64" value="20" />
            </div>
            <div class="col-4">
              <label for="ecc">Error Correction</label>
              <select id="ecc">
                <option value="L">L (7%)</option>
                <option value="M" selected>M (15%)</option>
                <option value="Q">Q (25%)</option>
                <option value="H">H (30%)</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col-4">
              <label for="dots">Dots Style</label>
              <select id="dots">
                <option value="square">Square</option>
                <option value="dots">Dots</option>
                <option value="rounded" selected>Rounded</option>
                <option value="classy">Classy</option>
                <option value="classy-rounded">Classy Rounded</option>
                <option value="extra-rounded">Extra Rounded</option>
              </select>
            </div>
            <div class="col-4">
              <label for="cornersSquare">Eyes Square</label>
              <select id="cornersSquare">
                <option value="square">Square</option>
                <option value="dot">Dot</option>
                <option value="extra-rounded" selected>Extra Rounded</option>
              </select>
            </div>
            <div class="col-4">
              <label for="cornersDot">Eyes Dot</label>
              <select id="cornersDot">
                <option value="square">Square</option>
                <option value="dot" selected>Dot</option>
                <option value="extra-rounded">Extra Rounded</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col-6">
              <label>QR Color</label>
              <div class="row">
                <div class="col-6"><input id="qrColor1" type="text" value="#111827" /></div>
                <div class="col-6">
                  <select id="qrColorMode">
                    <option value="solid" selected>Solid</option>
                    <option value="linear">Linear Gradient</option>
                    <option value="radial">Radial Gradient</option>
                  </select>
                </div>
              </div>
              <div class="row" style="margin-top:6px" id="qrColor2Row" hidden>
                <div class="col-6"><input id="qrColor2" type="text" value="#2563eb" /></div>
                <div class="col-6">
                  <select id="qrGradPos">
                    <option value="0">Top→Bottom</option>
                    <option value="90" selected>Left→Right</option>
                    <option value="45">↘︎ Diagonal</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="col-6">
              <label>Background</label>
              <div class="row">
                <div class="col-6"><input id="bgColor1" type="text" value="#ffffff" /></div>
                <div class="col-6">
                  <select id="bgColorMode">
                    <option value="solid" selected>Solid</option>
                    <option value="linear">Linear Gradient</option>
                    <option value="radial">Radial Gradient</option>
                  </select>
                </div>
              </div>
              <div class="row" style="margin-top:6px" id="bgColor2Row" hidden>
                <div class="col-6"><input id="bgColor2" type="text" value="#f1f5f9" /></div>
                <div class="col-6">
                  <select id="bgGradPos">
                    <option value="0">Top→Bottom</option>
                    <option value="90" selected>Left→Right</option>
                    <option value="45">↘︎ Diagonal</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col-4">
              <label for="logoUpload">Logo (PNG/SVG)</label>
              <input id="logoUpload" type="file" accept="image/*,.svg" />
            </div>
            <div class="col-4">
              <label for="logoSize">Logo Size (%)</label>
              <input id="logoSize" type="number" min="10" max="60" value="25" />
            </div>
            <div class="col-4">
              <label for="logoMargin">Logo Margin (px)</label>
              <input id="logoMargin" type="number" min="0" max="30" value="2" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col-4">
              <label for="format">Export</label>
              <select id="format">
                <option value="png" selected>PNG</option>
                <option value="svg">SVG</option>
                <option value="jpeg">JPEG</option>
                <option value="webp">WEBP</option>
              </select>
            </div>
            <div class="col-4">
              <label for="scale">Export Scale (DPI)</label>
              <input id="scale" type="number" min="1" max="8" value="2" />
            </div>
            <div class="col-4">
              <label for="transparentBg">Transparent BG</label>
              <select id="transparentBg">
                <option value="no" selected>No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
          </div>

          <div class="actions" style="margin-top:14px">
            <button class="primary" id="btnRender">Render</button>
            <button class="success" id="btnDownload">Download</button>
            <button id="btnCopy">Copy</button>
            <button id="btnPrint">Print</button>
            <button id="btnSaveTemplate">Save Template</button>
            <button id="btnLoadTemplate">Load Template</button>
          </div>
          <p class="note">Shortcuts: <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> render · <span class="kbd">Ctrl</span>+<span class="kbd">S</span> download</p>
        </div>

        <!-- RIGHT Preview -->
        <div class="card right">
          <h2 style="margin:0 0 8px">Preview</h2>
          <div id="stage" class="preview"></div>
          <div class="footer">Tip: Use higher ECC when adding logos or shrinking size. Maintain contrast for scan reliability.</div>
        </div>
      </div>
    </section>

    <!-- ============= SCANNER PANEL ============= -->
    <section id="pScan" hidden>
      <div class="grid">
        <div class="card left">
          <h2 style="margin:0 0 8px">Scan via Camera</h2>
          <div class="actions" style="margin-bottom:10px">
            <button class="primary" id="camStart">Start Camera</button>
            <button id="camStop" disabled>Stop</button>
            <select id="camSelect" disabled></select>
            <span class="pill">HTTPS required</span>
          </div>
          <div class="preview" style="position:relative">
            <video id="video" autoplay playsinline style="width:100%;max-height:480px;transform:scaleX(-1)"></video>
            <canvas id="overlay" style="position:absolute;inset:0"></canvas>
          </div>
          <div class="footer" id="scanStatus">Camera idle.</div>
        </div>

        <div class="card right">
          <h2 style="margin:0 0 8px">Scan from Image</h2>
          <div class="actions" style="margin-bottom:8px">
            <input type="file" id="imgFile" accept="image/*" />
            <button id="pasteImg">Paste from Clipboard</button>
          </div>
          <div id="imgPreview" class="preview" style="min-height:240px"></div>
          <h3 style="margin:12px 0 6px">Result</h3>
          <div class="card" style="background:#0b1220;padding:12px">
            <div id="decoded" class="mono muted">No QR decoded yet.</div>
            <div class="actions" style="margin-top:8px">
              <button id="copyDecoded" disabled>Copy Text</button>
              <a id="openDecoded" class="pill" href="#" target="_blank" rel="noopener" style="text-decoration:none;pointer-events:none">Open as Link</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============= BATCH PANEL ============= -->
    <section id="pBatch" hidden>
      <div class="grid">
        <div class="card left">
          <h2 style="margin:0 0 8px">Batch Generate (CSV → ZIP)</h2>
          <p class="note">Upload a CSV with columns: <span class="mono">text,filename,size,margin,ecc,dots,qrColor1,qrColor2,qrColorMode,bgColor1,bgColor2,bgColorMode,logoUrl,logoSize,logoMargin,format,scale</span>. Only <span class="mono">text</span> is required; others default to current UI values.</p>
          <div class="actions" style="margin-bottom:8px">
            <input id="csvFile" type="file" accept=".csv" />
            <button class="primary" id="runBatch">Generate ZIP</button>
            <button id="dlTemplate">Download CSV Template</button>
          </div>
          <div class="footer" id="batchStatus">Idle.</div>
        </div>
        <div class="card right">
          <h2 style="margin:0 0 8px">Templates</h2>
          <p class="note">Save your current configuration as a JSON template for reuse. You can also import a template file.</p>
          <div class="actions">
            <button id="exportTemplate">Export Template (.json)</button>
            <input id="importTemplate" type="file" accept="application/json" />
            <button id="resetDefaults">Reset to Defaults</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ============= ANALYTICS PANEL ============= -->
    <section id="pAnalytics" hidden>
      <div class="card">
        <h2 style="margin:0 0 8px">Analytics Integration (Optional)</h2>
        <p class="note">This app never sends data by default. Enable one of the adapters below or plug in your own. Events emitted: <span class="mono">qr_render</span>, <span class="mono">qr_download</span>, <span class="mono">qr_copy</span>, <span class="mono">qr_print</span>, <span class="mono">scan_success</span>, <span class="mono">batch_complete</span>.</p>
        <div class="row">
          <div class="col-6">
            <label for="gaId">Google Analytics 4 Measurement ID</label>
            <input id="gaId" type="text" placeholder="G-XXXXXXXXXX" />
            <button id="enableGA">Enable GA4</button>
          </div>
          <div class="col-6">
            <label for="plausibleDomain">Plausible Domain</label>
            <input id="plausibleDomain" type="text" placeholder="yourdomain.com" />
            <button id="enablePlausible">Enable Plausible</button>
          </div>
        </div>
        <div class="hr"></div>
        <pre class="mono" style="white-space:pre-wrap;background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:12px">// Custom adapter example
window.proQRAnalytics = {
  track: (eventName, payload={}) => {
    // Send to your endpoint
    // fetch('/analytics', {method:'POST',body:JSON.stringify({eventName, payload})})
    console.log('custom-analytics', eventName, payload)
  }
}
</pre>
      </div>
    </section>

    <!-- ============= ABOUT PANEL ============= -->
    <section id="pAbout" hidden>
      <div class="card">
        <h2 style="margin:0 0 8px">About</h2>
        <p class="note">Pro QR Studio is a single‑file, privacy‑first QR toolkit. Everything runs locally in your browser. Perfect for individuals and enterprises who need customization, batch work, and optional analytics — with zero servers.</p>
        <ul>
          <li>SVG/PNG/JPEG/WEBP export with scale (DPI)</li>
          <li>Gradients, shapes, custom eyes, logo overlay</li>
          <li>Templates (save/load), presets (Wi‑Fi, vCard, etc.)</li>
          <li>Batch CSV → ZIP (client‑side)</li>
          <li>Scanner (camera / images)</li>
          <li>Analytics adapters (GA4, Plausible, custom)</li>
        </ul>
        <p class="note">Security tip: host via HTTPS (GitHub Pages works great). Camera requires HTTPS/localhost.</p>
      </div>
    </section>

  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const show = (el, v=true) => { el.hidden = !v }
    const toast = (msg) => { const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600) }

    // ---------- Tabs ----------
    const tabs = [ ['tGen','pGen'], ['tScan','pScan'], ['tBatch','pBatch'], ['tAnalytics','pAnalytics'], ['tAbout','pAbout'] ]
    tabs.forEach(([tId,pId])=>{
      $(tId).addEventListener('click',()=>{
        tabs.forEach(([t2,p2])=>{ $(t2).classList.toggle('active', t2===tId); show($(p2), p2===pId) })
        if (pId!== 'pScan') stopCamera()
      })
    })

    // ---------- Presets ----------
    const preset = $('preset');
    preset.addEventListener('change', ()=>{
      const v = preset.value;
      if (v==='wifi') {
        $('content').value = 'WIFI:T:WPA;S:MySSID;P:mypassword;;'
      } else if (v==='vcard') {
        $('content').value = `BEGIN:VCARD\nVERSION:3.0\nN:Doe;John;;;\nFN:John Doe\nTEL;TYPE=CELL:+11234567890\nEMAIL:john@example.com\nORG:Example Inc\nTITLE:Engineer\nEND:VCARD`
      } else if (v==='sms') {
        $('content').value = 'SMSTO:+11234567890:Hello there'
      } else if (v==='email') {
        $('content').value = 'mailto:hello@example.com?subject=Hi&body=Message'
      } else if (v==='geo') {
        $('content').value = 'geo:37.786971,-122.399677'
      } else if (v==='event') {
        $('content').value = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:Sample Event\nDTSTART:20250101T090000Z\nDTEND:20250101T100000Z\nEND:VEVENT\nEND:VCALENDAR`
      }
    })

    // ---------- QR Instance (qr-code-styling) ----------
    let qr = null; let logoDataUrl = null;

    function gradientCfg(mode, c1, c2, angle=90) {
      if (mode==='solid') return { color: c1 };
      return {
        gradient: mode==='linear' ? 'linear' : 'radial',
        rotation: (angle * Math.PI)/180,
        colorStops: [ { offset: 0, color: c1 }, { offset: 1, color: c2 } ]
      }
    }

    async function buildOptions() {
      const size = clamp(parseInt($('size').value||512,10),128,2048)
      const margin = clamp(parseInt($('margin').value||20,10),0,64)
      const ecc = $('ecc').value
      const dots = $('dots').value
      const cs = $('cornersSquare').value
      const cd = $('cornersDot').value
      const qrMode = $('qrColorMode').value
      const bgMode = $('bgColorMode').value
      const qrColor1 = $('qrColor1').value || '#111827'
      const qrColor2 = $('qrColor2').value || '#2563eb'
      const bgColor1 = $('bgColor1').value || '#ffffff'
      const bgColor2 = $('bgColor2').value || '#f1f5f9'
      const qAngle = parseInt($('qrGradPos').value||90,10)
      const bAngle = parseInt($('bgGradPos').value||90,10)

      const imageOptions = logoDataUrl ? {
        image: logoDataUrl,
        imageOptions: { crossOrigin: 'anonymous', margin: clamp(parseInt($('logoMargin').value||2,10),0,30), imageSize: clamp(parseInt($('logoSize').value||25,10),10,60) / 100 }
      } : {}

      return {
        width: size, height: size, type: 'svg', data: $('content').value.trim() || ' ',
        margin, qrOptions: { errorCorrectionLevel: ecc },
        dotsOptions: { type: dots, ...gradientCfg(qrMode, qrColor1, qrColor2, qAngle) },
        backgroundOptions: { ...gradientCfg(bgMode, bgColor1, bgColor2, bAngle) },
        cornersSquareOptions: { type: cs, color: qrColor1 },
        cornersDotOptions: { type: cd, color: qrColor1 },
        ...imageOptions
      }
    }

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)) }

    async function renderQR() {
      const opts = await buildOptions()
      if (qr) { $('stage').innerHTML = '' }
      qr = new QRCodeStyling(opts)
      qr.append($('stage'))
      track('qr_render', { size: opts.width, ecc: opts.qrOptions.errorCorrectionLevel })
      toast('Rendered QR')
    }

    async function downloadQR() {
      if (!qr) await renderQR()
      const name = sanitizeFileName(($('filename').value||'qr-code').trim())
      const format = $('format').value
      const scale = clamp(parseInt($('scale').value||2,10),1,8)
      const transparent = $('transparentBg').value==='yes'
      await qr.download({ name, extension: format, scale, background: transparent ? 'transparent' : undefined })
      track('qr_download', { format, scale })
    }

    async function copyQR() {
      if (!qr) await renderQR()
      const blob = await qr.getRawData('png')
      if (!blob) return alert('Copy not supported for this format, switch to PNG')
      try {
        await navigator.clipboard.write([ new ClipboardItem({ [blob.type]: blob }) ])
        toast('Copied image to clipboard')
        track('qr_copy')
      } catch(e) { alert('Copy failed: '+e.message) }
    }

    async function printQR() {
      if (!qr) await renderQR()
      const blob = await qr.getRawData('png')
      const url = URL.createObjectURL(blob)
      const w = window.open('', 'qr-print')
      w.document.write(`<!doctype html><title>Print QR</title><style>body{margin:0;display:grid;place-items:center}img{width:90vw;max-width:900px}</style><img src="${url}">`)
      w.document.close(); w.focus(); w.print();
      setTimeout(()=>URL.revokeObjectURL(url), 2000)
      track('qr_print')
    }

    function sanitizeFileName(s){ return s.replace(/[^a-z0-9-_]+/gi,'-').replace(/^-+|-+$/g,'').toLowerCase() || 'qr-code' }

    // Toggle gradient inputs visibility
    function toggleGradRows(){
      $('qrColor2Row').hidden = $('qrColorMode').value==='solid'
      $('bgColor2Row').hidden = $('bgColorMode').value==='solid'
    }
    $('qrColorMode').addEventListener('change', toggleGradRows)
    $('bgColorMode').addEventListener('change', toggleGradRows)
    toggleGradRows()

    // Logo uploader
    $('logoUpload').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return
      const url = URL.createObjectURL(f)
      // Convert to dataURL to keep in template/export reliably
      const data = await fileToDataURL(f)
      logoDataUrl = data
      toast('Logo loaded')
      URL.revokeObjectURL(url)
    })

    function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file) }) }

    // Buttons
    $('btnRender').addEventListener('click', renderQR)
    $('btnDownload').addEventListener('click', downloadQR)
    $('btnCopy').addEventListener('click', copyQR)
    $('btnPrint').addEventListener('click', printQR)

    // Templates (localStorage)
    const TEMPLATE_KEY = 'proqr_template_v1'
    $('btnSaveTemplate').addEventListener('click', ()=>{
      const t = currentTemplate()
      localStorage.setItem(TEMPLATE_KEY, JSON.stringify(t))
      toast('Template saved')
    })
    $('btnLoadTemplate').addEventListener('click', ()=>{
      const raw = localStorage.getItem(TEMPLATE_KEY)
      if (!raw) return alert('No saved template')
      applyTemplate(JSON.parse(raw))
      toast('Template loaded')
      renderQR()
    })

    function currentTemplate(){
      return {
        content: $('content').value, filename: $('filename').value,
        size: $('size').value, margin: $('margin').value, ecc: $('ecc').value,
        dots: $('dots').value, cornersSquare: $('cornersSquare').value, cornersDot: $('cornersDot').value,
        qrColorMode: $('qrColorMode').value, qrColor1: $('qrColor1').value, qrColor2: $('qrColor2').value, qrGradPos: $('qrGradPos').value,
        bgColorMode: $('bgColorMode').value, bgColor1: $('bgColor1').value, bgColor2: $('bgColor2').value, bgGradPos: $('bgGradPos').value,
        logoDataUrl, logoSize: $('logoSize').value, logoMargin: $('logoMargin').value,
        format: $('format').value, scale: $('scale').value, transparentBg: $('transparentBg').value
      }
    }

    function applyTemplate(t){
      const set = (id,val)=>{ if($(id)) $(id).value = val }
      for(const k in t){ if($(k)) set(k, t[k]) }
      logoDataUrl = t.logoDataUrl || null
      toggleGradRows()
    }

    // Export / Import Template files
    $('exportTemplate').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(currentTemplate(), null, 2)], {type:'application/json'})
      saveAs(blob, 'proqr-template.json')
    })
    $('importTemplate').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return
      const txt = await f.text()
      applyTemplate(JSON.parse(txt))
      renderQR()
      toast('Template imported')
      e.target.value = ''
    })
    $('resetDefaults').addEventListener('click', ()=>{ location.reload() })

    // Shortcuts
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='enter') { e.preventDefault(); renderQR() }
      if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s') { e.preventDefault(); downloadQR() }
    })

    // Initial render
    renderQR()

    // ---------- Scanner ----------
    let stream=null, animId=null, scanning=false
    const video = $('video'), overlay=$('overlay'), scanStatus=$('scanStatus')

    async function listCameras(){
      const devices = await navigator.mediaDevices.enumerateDevices()
      const cams = devices.filter(d=>d.kind==='videoinput')
      const sel = $('camSelect'); sel.innerHTML='';
      cams.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.deviceId; o.textContent=c.label||`Camera ${i+1}`; sel.appendChild(o) })
      sel.disabled = cams.length===0
    }

    async function startCamera(){
      if(!navigator.mediaDevices?.getUserMedia) return alert('Camera API not supported')
      try{ await listCameras();
        const constraints={ video:{ deviceId: $('camSelect').value?{exact:$('camSelect').value}:undefined, facingMode: $('camSelect').value?undefined:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }, audio:false }
        stream = await navigator.mediaDevices.getUserMedia(constraints)
        video.srcObject = stream; await video.play();
        $('camSelect').disabled=false; $('camStop').disabled=false; scanning=true; scanStatus.textContent='Scanning…'
        loopScan()
      }catch(e){ alert('Unable to access camera: '+e.message+'\n(HTTPS or localhost required)') }
    }

    function stopCamera(){ scanning=false; if(animId) cancelAnimationFrame(animId); if(stream) stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; $('camStop').disabled=true; scanStatus.textContent='Camera stopped.'; const ctx=overlay.getContext('2d'); ctx&&ctx.clearRect(0,0,overlay.width,overlay.height) }

    async function loopScan(){
      const ctx=overlay.getContext('2d'); const w=overlay.width=video.videoWidth||overlay.clientWidth; const h=overlay.height=video.videoHeight||360
      drawGuide(ctx,w,h)
      const work=document.createElement('canvas'); work.width=w; work.height=h; const wctx=work.getContext('2d'); wctx.drawImage(video,0,0,w,h)
      const img=wctx.getImageData(0,0,w,h); const code=jsQR(img.data,w,h,{inversionAttempts:'dontInvert'})
      if(code&&code.data){ scanning=false; highlight(ctx,code.location); onDecoded(code.data); await new Promise(r=>setTimeout(r,900)); scanning=true }
      if(scanning) animId=requestAnimationFrame(loopScan)
    }

    function drawGuide(ctx,w,h){ ctx.clearRect(0,0,w,h); ctx.lineWidth=3; ctx.strokeStyle='rgba(34,211,238,.9)'; const s=Math.min(w,h)*0.7; const x=(w-s)/2, y=(h-s)/2; const r=18; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+s-r,y); ctx.quadraticCurveTo(x+s,y,x+s,y+r); ctx.lineTo(x+s,y+s-r); ctx.quadraticCurveTo(x+s,y+s,x+s-r,y+s); ctx.lineTo(x+r,y+s); ctx.quadraticCurveTo(x,y+s,x,y+s-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.stroke() }
    function highlight(ctx,loc){ if(!loc) return; ctx.strokeStyle='rgba(56,189,248,.95)'; ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(loc.topLeftCorner.x,loc.topLeftCorner.y); ctx.lineTo(loc.topRightCorner.x,loc.topRightCorner.y); ctx.lineTo(loc.bottomRightCorner.x,loc.bottomRightCorner.y); ctx.lineTo(loc.bottomLeftCorner.x,loc.bottomLeftCorner.y); ctx.closePath(); ctx.stroke() }
    function onDecoded(text){ $('decoded').textContent=text; $('copyDecoded').disabled=false; try{ const u=new URL(text); const a=$('openDecoded'); a.href=u.href; a.style.pointerEvents='auto'; a.textContent='Open Link' }catch{ const a=$('openDecoded'); a.href='#'; a.style.pointerEvents='none'; a.textContent='Open as Link' } scanStatus.innerHTML='<span style="color:var(--ok)">Decoded!</span>'; track('scan_success') }

    $('camStart').addEventListener('click', startCamera)
    $('camStop').addEventListener('click', stopCamera)
    $('camSelect').addEventListener('change', ()=>{ if(stream){ stopCamera(); startCamera() } })

    $('imgFile').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const url=URL.createObjectURL(f); await decodeFromImageURL(url); URL.revokeObjectURL(url) })
    $('pasteImg').addEventListener('click', async ()=>{ try{ const items=await navigator.clipboard.read(); for(const it of items){ for(const t of it.types){ if(t.startsWith('image/')){ const blob=await it.getType(t); const url=URL.createObjectURL(blob); await decodeFromImageURL(url); URL.revokeObjectURL(url); return } } } alert('No image in clipboard') }catch(e){ alert('Clipboard read not supported or permission denied') } })
    $('copyDecoded').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText($('decoded').textContent||''); toast('Copied text'); }catch(e){ alert('Copy failed: '+e.message) } })

    async function decodeFromImageURL(url){ $('imgPreview').innerHTML=''; const img=new Image(); img.onload=()=>{ $('imgPreview').appendChild(img); const c=document.createElement('canvas'); c.width=img.naturalWidth; c.height=img.naturalHeight; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0); const d=ctx.getImageData(0,0,c.width,c.height); const code=jsQR(d.data,c.width,c.height); if(code&&code.data){ onDecoded(code.data) } else { $('decoded').textContent='No QR found in image.'; $('copyDecoded').disabled=true; const a=$('openDecoded'); a.href='#'; a.style.pointerEvents='none' } }; img.onerror=()=>alert('Could not load image'); img.src=url; img.style.maxWidth='100%'; }

    // ---------- Batch ----------
    const CSV_HEADER = 'text,filename,size,margin,ecc,dots,qrColor1,qrColor2,qrColorMode,bgColor1,bgColor2,bgColorMode,logoUrl,logoSize,logoMargin,format,scale\n'

    $('dlTemplate').addEventListener('click', ()=>{ const blob=new Blob([CSV_HEADER+`Hello World,hello,512,20,M,rounded,#111827,#2563eb,linear,#ffffff,#f1f5f9,solid,,25,2,png,2\n`],{type:'text/csv'}); saveAs(blob,'proqr-template.csv') })

    $('runBatch').addEventListener('click', async ()=>{
      const f = $('csvFile').files?.[0]; if(!f) return alert('Choose a CSV file');
      const text = await f.text(); const rows = parseCSV(text); if(rows.length===0) return alert('CSV is empty');
      $('batchStatus').textContent = 'Generating…';
      const zip = new JSZip(); let count=0;
      for(const r of rows){ try {
          const cfg = rowToConfig(r); const imgBlob = await generateOne(cfg); const name = sanitizeFileName(cfg.filename||'qr')+'.'+(cfg.format||'png'); zip.file(name, imgBlob); count++; }
        catch(e){ console.error('Row failed', r, e) }
      }
      const content = await zip.generateAsync({type:'blob'}); saveAs(content, 'qr-batch.zip'); $('batchStatus').textContent = `Done. ${count} files in qr-batch.zip`; toast('Batch complete'); track('batch_complete', { count })
    })

    function parseCSV(str){
      const lines = str.split(/\r?\n/).filter(Boolean); if(lines.length===0) return []
      const header = lines[0].split(',').map(s=>s.trim());
      const rows = [];
      for(let i=1;i<lines.length;i++){
        const cols = smartSplit(lines[i]);
        const obj = {}; header.forEach((h,idx)=>obj[h]=cols[idx]!==undefined?cols[idx].trim():undefined); rows.push(obj)
      }
      return rows
    }
    function smartSplit(line){ // handles simple quoted CSV
      const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ inQ=!inQ; continue } if(ch===',' && !inQ){ out.push(cur); cur=''; } else { cur+=ch } } out.push(cur); return out }

    function rowToConfig(r){
      const base = currentTemplate();
      return {
        text: r.text || base.content,
        filename: r.filename || base.filename,
        size: num(r.size, base.size), margin: num(r.margin, base.margin), ecc: (r.ecc||base.ecc||'M'),
        dots: r.dots||base.dots,
        qrColor1: r.qrColor1||base.qrColor1, qrColor2: r.qrColor2||base.qrColor2, qrColorMode: r.qrColorMode||base.qrColorMode, qrGradPos: base.qrGradPos,
        bgColor1: r.bgColor1||base.bgColor1, bgColor2: r.bgColor2||base.bgColor2, bgColorMode: r.bgColorMode||base.bgColorMode, bgGradPos: base.bgGradPos,
        logoUrl: r.logoUrl||null, logoSize: num(r.logoSize, base.logoSize), logoMargin: num(r.logoMargin, base.logoMargin),
        format: (r.format||base.format||'png'), scale: num(r.scale, base.scale)
      }
    }
    function num(v, fallback){ const n=parseInt(v,10); return Number.isFinite(n)?n:parseInt(fallback,10) }

    async function generateOne(cfg){
      // load logo if provided (URL)
      let imageOpt = {}; if(cfg.logoUrl){ try { const dataUrl = await fetchToDataUrl(cfg.logoUrl); imageOpt = { image: dataUrl, imageOptions:{ margin:cfg.logoMargin||2, imageSize:(cfg.logoSize||25)/100 } } } catch(e){ console.warn('Logo fetch failed', e) } }
      const opts = {
        width: parseInt(cfg.size||512,10), height: parseInt(cfg.size||512,10), type:'svg', data: cfg.text,
        margin: parseInt(cfg.margin||20,10), qrOptions: { errorCorrectionLevel: cfg.ecc||'M' },
        dotsOptions: { type: cfg.dots||'rounded', ...gradientCfg(cfg.qrColorMode||'solid', cfg.qrColor1||'#111827', cfg.qrColor2||'#2563eb', parseInt(cfg.qrGradPos||90,10)) },
        backgroundOptions: { ...gradientCfg(cfg.bgColorMode||'solid', cfg.bgColor1||'#ffffff', cfg.bgColor2||'#f1f5f9', parseInt(cfg.bgGradPos||90,10)) },
        cornersSquareOptions: { type: $('cornersSquare').value, color: cfg.qrColor1||'#111827' },
        cornersDotOptions: { type: $('cornersDot').value, color: cfg.qrColor1||'#111827' },
        ...imageOpt
      }
      const q = new QRCodeStyling(opts)
      const format = (cfg.format||'png').toLowerCase(); const scale = clamp(parseInt(cfg.scale||2,10),1,8)
      const blob = await q.getRawData(format, {scale})
      return blob
    }

    async function fetchToDataUrl(url){ const res=await fetch(url); const blob=await res.blob(); return await new Promise((resv)=>{ const fr=new FileReader(); fr.onload=()=>resv(fr.result); fr.readAsDataURL(blob) }) }

    // ---------- Analytics ----------
    window.proQRAnalytics = window.proQRAnalytics || { track: (name,payload={}) => console.log('[analytics]', name, payload) }
    function track(name, payload){ try{ window.proQRAnalytics.track(name, payload) }catch(e){ console.warn('analytics error', e) } }

    $('enableGA').addEventListener('click', ()=>{
      const id = $('gaId').value.trim(); if(!id) return alert('Enter GA4 Measurement ID')
      // Inject GA4
      const s1=document.createElement('script'); s1.async=true; s1.src=`https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(id)}`; document.head.appendChild(s1)
      const s2=document.createElement('script'); s2.innerHTML = `window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '${id}'); window.proQRAnalytics = { track: (n,p={}) => gtag('event', n, p) }`; document.head.appendChild(s2)
      toast('GA4 enabled')
    })

    $('enablePlausible').addEventListener('click', ()=>{
      const domain = $('plausibleDomain').value.trim(); if(!domain) return alert('Enter domain')
      const s=document.createElement('script'); s.defer=true; s.setAttribute('data-domain', domain); s.src='https://plausible.io/js/plausible.js'; document.head.appendChild(s)
      window.proQRAnalytics = { track: (n,p={}) => window.plausible ? window.plausible(n, { props:p }) : console.log('[plausible]', n, p) }
      toast('Plausible enabled')
    })

  </script>
</body>
</html>
